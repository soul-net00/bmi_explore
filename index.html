<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cellphone Shop Management System</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    .header { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
    .header h1 { color: #667eea; font-size: 28px; }
    .header-btns { display: flex; gap: 10px; }
    .header-btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; }
    .btn-export { background: #10b981; color: white; }
    .btn-import { background: #3b82f6; color: white; }
    .btn-export:hover { background: #059669; transform: translateY(-2px); }
    .btn-import:hover { background: #2563eb; transform: translateY(-2px); }
    
    .tabs { background: white; border-radius: 15px; padding: 15px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; gap: 10px; flex-wrap: wrap; }
    .tab-btn { padding: 12px 25px; border: none; background: #f3f4f6; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; color: #6b7280; }
    .tab-btn:hover { background: #e5e7eb; }
    .tab-btn.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    
    .content { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-weight: 600; margin-bottom: 8px; color: #374151; }
    .form-group input, .form-group select, .form-group textarea { padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: 0.3s; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
    
    .btn { padding: 12px 30px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; font-size: 14px; }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-secondary:hover { background: #4b5563; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th { background: #f9fafb; padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e5e7eb; }
    td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
    tr:hover { background: #f9fafb; }
    
    .summary-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 12px; margin-top: 20px; }
    .summary-card h3 { margin-bottom: 15px; }
    .summary-total { font-size: 36px; font-weight: bold; }
    
    .receipt-card { background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #667eea; cursor: pointer; transition: 0.3s; }
    .receipt-card:hover { background: #f3f4f6; transform: translateX(5px); }
    .receipt-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .receipt-code { font-size: 18px; font-weight: bold; color: #667eea; }
    .receipt-amount { font-size: 24px; font-weight: bold; color: #10b981; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-close { background: none; border: none; font-size: 30px; cursor: pointer; color: #6b7280; }
    .modal-close:hover { color: #ef4444; }
    
    .settings-locked { text-align: center; padding: 50px; }
    .settings-locked .lock-icon { font-size: 80px; margin-bottom: 20px; }
    
    .action-btns { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
    
    .warning-box { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 8px; margin: 20px 0; }
    .warning-box h4 { color: #92400e; margin-bottom: 5px; }
    .warning-box p { color: #78350f; font-size: 14px; }
    
    .checkbox-group { display: flex; align-items: center; gap: 10px; }
    .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
    
    .logo-preview-box { margin-top: 15px; padding: 15px; border: 2px dashed #e5e7eb; border-radius: 8px; text-align: center; }
    .logo-preview-box img { max-width: 200px; max-height: 150px; border: 2px solid #e5e7eb; border-radius: 8px; }
    
    @media (max-width: 768px) {
      .header { flex-direction: column; gap: 15px; }
      .form-grid { grid-template-columns: 1fr; }
      .tabs { justify-content: center; }
      .receipt-header { flex-direction: column; align-items: flex-start; gap: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>üì± Cellphone Shop Management</h1>
        <p style="color: #6b7280; margin-top: 5px;">Professional Receipt System</p>
      </div>
      <div class="header-btns">
        <button class="header-btn btn-export" onclick="exportDatabase()">üì• Export Database</button>
        <label class="header-btn btn-import" style="cursor: pointer;">
          üì§ Import Database
          <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importDatabase(event)">
        </label>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('new-receipt')">‚ûï New Receipt</button>
      <button class="tab-btn" onclick="switchTab('history')">üìú History</button>
      <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
    </div>

    <div class="content">
      <!-- NEW RECEIPT TAB -->
      <div id="new-receipt" class="tab-content active">
        <h2 style="margin-bottom: 20px; color: #667eea;">Create New Receipt</h2>
        
        <div class="warning-box">
          <h4>‚ö†Ô∏è Important: Data Storage Notice</h4>
          <p>Your data is saved in your browser. Clear your browser cache = lose all data! Export regularly to backup.</p>
        </div>

        <h3 style="margin-bottom: 15px;">Customer Information</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Phone Number *</label>
            <input type="tel" id="customerPhone" placeholder="0821234567" required>
          </div>
          <div class="form-group">
            <label>Customer Name</label>
            <input type="text" id="customerName" placeholder="John Doe">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="customerEmail" placeholder="customer@email.com">
          </div>
        </div>

        <h3 style="margin: 30px 0 15px;">Add Items</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Description *</label>
            <input type="text" id="itemDescription" placeholder="Screen replacement">
          </div>
          <div class="form-group">
            <label>Category *</label>
            <select id="itemCategory">
              <option>Repair Service</option>
              <option>Software Update</option>
              <option>Battery</option>
              <option>Screen Protector</option>
              <option>Phone Case</option>
              <option>Charger</option>
              <option>Cable</option>
              <option>Earphones</option>
              <option>Memory Card</option>
              <option>SIM Card</option>
              <option>Other Accessories</option>
            </select>
          </div>
          <div class="form-group">
            <label>Quantity *</label>
            <input type="number" id="itemQuantity" value="1" min="1">
          </div>
          <div class="form-group">
            <label>Price (R) *</label>
            <input type="number" id="itemPrice" placeholder="0.00" step="0.01" min="0">
          </div>
        </div>
        
        <div class="checkbox-group" style="margin: 15px 0;">
          <input type="checkbox" id="applyDiscount" onchange="toggleDiscount()">
          <label for="applyDiscount" style="margin: 0; cursor: pointer;">Apply Discount</label>
          <input type="number" id="discountPercent" placeholder="%" min="0" max="100" style="width: 80px; padding: 8px; border-radius: 5px; border: 2px solid #e5e7eb;" disabled>
        </div>

        <button class="btn btn-primary" onclick="addItem()" style="width: 100%;">‚ûï Add Item to Receipt</button>

        <div id="itemsTableContainer" style="display: none; margin-top: 30px;">
          <h3>Items on Receipt</h3>
          <table id="itemsTable">
            <thead>
              <tr>
                <th>Description</th>
                <th>Category</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Total</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="itemsTableBody"></tbody>
          </table>
        </div>

        <div class="summary-card" id="summaryCard" style="display: none;">
          <h3>Receipt Summary</h3>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
            <div>
              <p>Total Items: <span id="totalItems">0</span></p>
            </div>
            <div style="text-align: right;">
              <p style="font-size: 14px; opacity: 0.9;">TOTAL AMOUNT</p>
              <div class="summary-total">R <span id="totalAmount">0.00</span></div>
            </div>
          </div>

          <div class="form-group" style="margin-top: 20px;">
            <label style="color: white;">Notes (Optional)</label>
            <textarea id="receiptNotes" rows="3" placeholder="Additional notes..."></textarea>
          </div>

          <div class="action-btns">
            <button class="btn btn-success" onclick="saveReceipt()" style="flex: 1;">üíæ Save Receipt</button>
            <button class="btn btn-secondary" onclick="clearReceipt()">üóëÔ∏è Clear All</button>
          </div>
        </div>
      </div>

      <!-- HISTORY TAB -->
      <div id="history" class="tab-content">
        <h2 style="margin-bottom: 20px; color: #667eea;">Receipt History</h2>
        
        <div class="form-grid">
          <div class="form-group">
            <label>Search by Phone / Receipt ID / Receipt Code</label>
            <input type="text" id="searchTerm" placeholder="Enter search term...">
          </div>
          <div style="display: flex; align-items: flex-end;">
            <button class="btn btn-primary" onclick="searchReceipts()" style="width: 100%;">üîç Search</button>
          </div>
        </div>

        <div id="searchResults"></div>
      </div>

      <!-- SETTINGS TAB -->
      <div id="settings" class="tab-content">
        <div id="settingsLocked" class="settings-locked">
          <div class="lock-icon">üîí</div>
          <h2 style="margin-bottom: 15px;">Settings Locked</h2>
          <p style="color: #6b7280; margin-bottom: 25px;">Enter password to unlock settings</p>
          <div style="max-width: 400px; margin: 0 auto;">
            <input type="password" id="passwordInput" placeholder="Enter password" style="width: 100%; padding: 15px; border-radius: 8px; border: 2px solid #e5e7eb; margin-bottom: 15px;">
            <button class="btn btn-primary" onclick="unlockSettings()" style="width: 100%;">üîì Unlock Settings</button>
            <p style="margin-top: 15px; color: #6b7280; font-size: 14px;">Default password: admin123</p>
          </div>
        </div>

        <div id="settingsUnlocked" style="display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="color: #667eea;">Company Settings</h2>
            <button class="btn btn-danger" onclick="lockSettings()">üîí Lock Settings</button>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>Company Name</label>
              <input type="text" id="settingCompanyName" placeholder="Your Company Name">
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="settingPhone" placeholder="(555) 123-4567">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="settingEmail" placeholder="info@company.com">
            </div>
            <div class="form-group">
              <label>Address</label>
              <input type="text" id="settingAddress" placeholder="123 Main Street, City">
            </div>
          </div>

          <div class="form-group" style="margin-top: 20px;">
            <label>Warranty Text</label>
            <textarea id="settingWarranty" rows="2" placeholder="Warranty: 30 days on all repairs"></textarea>
          </div>

          <div class="form-group" style="margin-top: 20px;">
            <label>Company Logo</label>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
              <input type="file" id="logoUpload" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
              <button class="btn btn-primary" onclick="document.getElementById('logoUpload').click()">üì∑ Upload Logo</button>
              <span id="logoStatus" style="color: #6b7280;">No logo uploaded</span>
            </div>
            <div id="logoPreview" class="logo-preview-box" style="display: none;">
              <img id="logoImage" alt="Company Logo Preview">
              <br>
              <button class="btn btn-danger" onclick="removeLogo()" style="margin-top: 10px; padding: 8px 20px;">Remove Logo</button>
            </div>
          </div>

          <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin: 25px 0;">
            <h3 style="margin-bottom: 15px;">Database Statistics</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
              <div>
                <p style="color: #6b7280;">Total Receipts</p>
                <p style="font-size: 32px; font-weight: bold; color: #667eea;" id="totalReceiptsCount">0</p>
              </div>
              <div>
                <p style="color: #6b7280;">Total Customers</p>
                <p style="font-size: 32px; font-weight: bold; color: #10b981;" id="totalCustomersCount">0</p>
              </div>
            </div>
          </div>

          <div class="action-btns">
            <button class="btn btn-success" onclick="saveSettings()">üíæ Save All Settings</button>
            <button class="btn btn-secondary" onclick="changePassword()">üîë Change Password</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Receipt Details Modal -->
  <div class="modal" id="receiptModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Receipt Details</h2>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEYS = {
      receipts: 'cellphone_receipts',
      customers: 'cellphone_customers',
      settings: 'cellphone_settings'
    };

    let currentItems = [];
    let settings = getSettings();

    function getSettings() {
      const defaults = {
        companyName: 'CELLPHONE REPAIR SHOP',
        phone: '(555) 123-4567',
        email: 'info@cellshop.com',
        address: '123 Main Street, City, State',
        warranty: 'Warranty: 30 days on all repairs',
        password: 'admin123',
        logo: ''
      };
      const saved = localStorage.getItem(STORAGE_KEYS.settings);
      return saved ? JSON.parse(saved) : defaults;
    }

    function saveToStorage(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }

    function getFromStorage(key) {
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : (key === STORAGE_KEYS.receipts || key === STORAGE_KEYS.customers ? [] : {});
    }

    function generateReceiptCode() {
      const year = new Date().getFullYear();
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += chars[Math.floor(Math.random() * chars.length)];
      }
      return `RCP-${year}-${code}`;
    }

    function formatCurrency(amount) {
      return parseFloat(amount).toFixed(2);
    }

    function toggleDiscount() {
      document.getElementById('discountPercent').disabled = !document.getElementById('applyDiscount').checked;
      if (!document.getElementById('applyDiscount').checked) {
        document.getElementById('discountPercent').value = '';
      }
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');

      if (tabName === 'history') {
        loadAllReceipts();
      } else if (tabName === 'settings') {
        loadSettingsData();
      }
    }

    function addItem() {
      const description = document.getElementById('itemDescription').value.trim();
      const category = document.getElementById('itemCategory').value;
      const quantity = parseInt(document.getElementById('itemQuantity').value);
      const price = parseFloat(document.getElementById('itemPrice').value);

      if (!description || !price || price <= 0 || quantity <= 0) {
        alert('Please fill in all required fields correctly!');
        return;
      }

      let total = quantity * price;
      
      if (document.getElementById('applyDiscount').checked) {
        const discount = parseFloat(document.getElementById('discountPercent').value) || 0;
        if (discount > 0 && discount <= 100) {
          total = total * (1 - discount / 100);
        }
      }

      const item = {
        id: Date.now(),
        description,
        category,
        quantity,
        price,
        total
      };

      currentItems.push(item);
      renderItems();
      clearItemForm();
    }

    function removeItem(id) {
      currentItems = currentItems.filter(item => item.id !== id);
      renderItems();
    }

    function renderItems() {
      const tbody = document.getElementById('itemsTableBody');
      const container = document.getElementById('itemsTableContainer');
      const summary = document.getElementById('summaryCard');

      if (currentItems.length === 0) {
        container.style.display = 'none';
        summary.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      summary.style.display = 'block';

      tbody.innerHTML = currentItems.map(item => `
        <tr>
          <td>${item.description}</td>
          <td>${item.category}</td>
          <td>${item.quantity}</td>
          <td>R ${formatCurrency(item.price)}</td>
          <td><strong>R ${formatCurrency(item.total)}</strong></td>
          <td>
            <button class="btn btn-danger" style="padding: 5px 15px;" onclick="removeItem(${item.id})">Delete</button>
          </td>
        </tr>
      `).join('');

      const total = currentItems.reduce((sum, item) => sum + item.total, 0);
      document.getElementById('totalItems').textContent = currentItems.length;
      document.getElementById('totalAmount').textContent = formatCurrency(total);
    }

    function clearItemForm() {
      document.getElementById('itemDescription').value = '';
      document.getElementById('itemQuantity').value = '1';
      document.getElementById('itemPrice').value = '';
      document.getElementById('applyDiscount').checked = false;
      document.getElementById('discountPercent').value = '';
      document.getElementById('discountPercent').disabled = true;
      document.getElementById('itemCategory').selectedIndex = 0;
    }

    function clearReceipt() {
      if (currentItems.length > 0 && !confirm('Clear all items from this receipt?')) {
        return;
      }
      currentItems = [];
      renderItems();
      document.getElementById('customerPhone').value = '';
      document.getElementById('customerName').value = '';
      document.getElementById('customerEmail').value = '';
      document.getElementById('receiptNotes').value = '';
    }

    function saveReceipt() {
      const phone = document.getElementById('customerPhone').value.trim();
      const name = document.getElementById('customerName').value.trim();
      const email = document.getElementById('customerEmail').value.trim();
      const notes = document.getElementById('receiptNotes').value.trim();

      if (!phone || phone.length < 10) {
        alert('Please enter a valid phone number (at least 10 digits)!');
        return;
      }

      if (currentItems.length === 0) {
        alert('Please add at least one item!');
        return;
      }

      const receiptCode = generateReceiptCode();
      const total = currentItems.reduce((sum, item) => sum + item.total, 0);

      const receipt = {
        id: Date.now(),
        receiptCode,
        customerPhone: phone,
        customerName: name || 'Walk-in Customer',
        customerEmail: email,
        date: new Date().toISOString(),
        items: [...currentItems],
        total,
        notes
      };

      const receipts = getFromStorage(STORAGE_KEYS.receipts);
      receipts.push(receipt);
      saveToStorage(STORAGE_KEYS.receipts, receipts);

      const customers = getFromStorage(STORAGE_KEYS.customers);
      const existingCustomer = customers.find(c => c.phone === phone);
      if (existingCustomer) {
        existingCustomer.name = name;
        existingCustomer.email = email;
      } else {
        customers.push({ phone, name, email });
      }
      saveToStorage(STORAGE_KEYS.customers, customers);

      alert(`‚úÖ Receipt saved successfully!\n\nReceipt Code: ${receiptCode}\nTotal: R ${formatCurrency(total)}`);

      if (confirm('Would you like to print this receipt? üñ®Ô∏è')) {
        exportReceiptAsHTML(receipt.id);
      }

      clearReceipt();
    }

    function searchReceipts() {
      const term = document.getElementById('searchTerm').value.trim();
      if (!term) {
        loadAllReceipts();
        return;
      }

      const receipts = getFromStorage(STORAGE_KEYS.receipts);
      const results = receipts.filter(r => 
        r.customerPhone.includes(term) ||
        r.receiptCode.toUpperCase().includes(term.toUpperCase()) ||
        r.id.toString() === term
      );

      displayReceipts(results);
    }

    function loadAllReceipts() {
      const receipts = getFromStorage(STORAGE_KEYS.receipts);
      displayReceipts(receipts.reverse());
    }

    function displayReceipts(receipts) {
      const container = document.getElementById('searchResults');
      
      if (receipts.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">No receipts found</p>';
        return;
      }

      container.innerHTML = receipts.map(r => `
        <div class="receipt-card" onclick="viewReceipt(${r.id})">
          <div class="receipt-header">
            <div>
              <div class="receipt-code">${r.receiptCode}</div>
              <p style="color: #6b7280; margin-top: 5px;">${r.customerName} ‚Ä¢ ${r.customerPhone}</p>
              <p style="color: #9ca3af; font-size: 14px; margin-top: 3px;">${new Date(r.date).toLocaleString()}</p>
            </div>
            <div class="receipt-amount">R ${formatCurrency(r.total)}</div>
          </div>
          <p style="color: #6b7280; font-size: 14px;">${r.items.length} item(s)</p>
        </div>
      `).join('');
    }

    function viewReceipt(id) {
      const receipts = getFromStorage(STORAGE_KEYS.receipts);
      const receipt = receipts.find(r => r.id === id);
      if (!receipt) return;

      const modal = document.getElementById('receiptModal');
      const body = document.getElementById('modalBody');

      body.innerHTML = `
        <div style="text-align: center; border-bottom: 2px solid #e5e7eb; padding-bottom: 20px; margin-bottom: 20px;">
          <h2 style="color: #667eea;">${settings.companyName}</h2>
          <p>${settings.phone} ‚Ä¢ ${settings.email}</p>
          <p>${settings.address}</p>
        </div>

        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            <div>
              <p style="color: #6b7280; font-size: 14px;">Receipt #</p>
              <p style="font-weight: bold;">${receipt.id}</p>
            </div>
            <div>
              <p style="color: #6b7280; font-size: 14px;">Receipt Code</p>
              <p style="font-weight: bold; color: #667eea;">${receipt.receiptCode}</p>
            </div>
            <div>
              <p style="color: #6b7280; font-size: 14px;">Date</p>
              <p style="font-weight: bold;">${new Date(receipt.date).toLocaleString()}</p>
            </div>
            <div>
              <p style="color: #6b7280; font-size: 14px;">Customer</p>
              <p style="font-weight: bold;">${receipt.customerName}</p>
            </div>
          </div>
        </div>

        <h3 style="margin-bottom: 15px;">Items</h3>
        <table style="margin-bottom: 20px;">
          <thead>
            <tr>
              <th>Description</th>
              <th>Category</th>
              <th>Qty</th>
              <th>Price</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            ${receipt.items.map(item => `
              <tr>
                <td>${item.description}</td>
                <td>${item.category}</td>
                <td>${item.quantity}</td>
                <td>R ${formatCurrency(item.price)}</td>
                <td><strong>R ${formatCurrency(item.total)}</strong></td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; text-align: right;">
          <p style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">TOTAL AMOUNT</p>
          <p style="font-size: 36px; font-weight: bold;">R ${formatCurrency(receipt.total)}</p>
        </div>

        ${receipt.notes ? `<div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-top: 20px;">
          <p style="font-weight: bold; margin-bottom: 5px;">Notes:</p>
          <p>${receipt.notes}</p>
        </div>` : ''}

        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
          <p style="font-style: italic; color: #6b7280;">${settings.warranty}</p>
          <p style="margin-top: 10px; font-weight: bold;">Thank you for your business!</p>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 25px;">
          <button class="btn btn-primary" onclick="exportReceiptAsHTML(${receipt.id})" style="flex: 1;">üñ®Ô∏è Print Receipt</button>
          <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">Close</button>
        </div>
      `;

      modal.classList.add('active');
    }

    function closeModal() {
      document.getElementById('receiptModal').classList.remove('active');
    }

    function exportReceiptAsHTML(id) {
      const receipts = getFromStorage(STORAGE_KEYS.receipts);
      const receipt = receipts.find(r => r.id === id);
      if (!receipt) return;

      const html = generateReceiptHTML(receipt);
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    function generateReceiptHTML(receipt) {
      return `<!DOCTYPE html>
<html><head>
<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<title>Receipt ${receipt.id} - ${receipt.receiptCode}</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: Arial, sans-serif; padding: 40px; background: white; position: relative; }
@media print { body { padding: 20px; } }
.receipt-container { max-width: 100%; margin: 0; position: relative; z-index: 1; }

.watermark { position: fixed; top: 50%; left: 50%; 
              transform: translate(-50%, -50%) rotate(-45deg); 
              font-size: 80pt; font-weight: bold; 
              color: rgba(200, 200, 200, 0.12); 
              pointer-events: none; z-index: 0; 
              white-space: nowrap; user-select: none; 
              text-transform: uppercase; letter-spacing: 10px; }
@media print { .watermark { color: rgba(200, 200, 200, 0.12) !important; } }

.header-section { display: flex; align-items: flex-start; margin-bottom: 20px; }
.logo-section { flex: 0 0 150px; margin-right: 30px; }
.logo-section img { max-width: 150px; max-height: 150px; object-fit: contain; }
.company-info-section { flex: 1; }

.company-name { font-size: 18pt; font-weight: bold; margin: 0 0 10px 0; }
.company-detail { font-size: 10pt; margin: 5px 0; }
.separator { border-top: 2px solid black; margin: 20px 0; clear: both; }
.title { font-size: 16pt; font-weight: bold; text-align: center; margin: 20px 0; }

.info-box { background: #f5f5f5; border: 1px solid black; padding: 15px; margin: 20px 0; }
.info-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
.info-column { flex: 1; }
.info-label { font-weight: bold; display: inline-block; width: 110px; }
.info-value { display: inline-block; }
.code-value { color: #00008B; font-weight: bold; font-size: 10pt; }

table { width: 100%; border-collapse: collapse; margin: 20px 0; }
th { background: #dcdcdc; border: 1px solid black; padding: 8px; text-align: left; font-weight: bold; font-size: 10pt; }
td { border: 1px solid #ccc; padding: 8px; font-size: 9pt; }
tr:nth-child(even) { background: #fafafa; }
tr:nth-child(odd) { background: white; }

.total-box { background: #e6e6e6; border: 2px solid black; padding: 12px 15px; 
              margin: 25px 0; text-align: right; font-size: 12pt; font-weight: bold; }
.total-label { display: inline-block; margin-right: 20px; }
.total-value { display: inline-block; min-width: 150px; text-align: right; }

.notes-section { margin: 25px 0; }
.notes-title { font-weight: bold; margin-bottom: 10px; font-size: 10pt; }
.notes-content { border: 1px solid #ccc; padding: 10px; font-size: 9pt; min-height: 50px; }

.warranty { border-top: 1px solid gray; padding-top: 10px; margin-top: 25px; 
             font-size: 9pt; font-style: italic; color: #666; }

.disclaimer-section { border-top: 2px solid black; margin-top: 30px; padding-top: 12px; }
.disclaimer-title { font-weight: bold; font-size: 9pt; margin-bottom: 10px; }
.disclaimer-text { font-size: 6pt; line-height: 1.4; text-align: justify; }

.footer { margin-top: 40px; border-top: 1px solid black; padding-top: 12px; }
.signature-section { display: flex; justify-content: space-between; align-items: flex-end; margin: 20px 0; }
.signature-line { flex: 1; max-width: 300px; }
.signature-label { font-size: 9pt; margin-bottom: 5px; }
.signature-underline { border-bottom: 1px solid black; height: 30px; }
.fingerprint-box { width: 100px; height: 60px; border: 1px solid black; text-align: center; padding-top: 20px; font-size: 8pt; color: #999; }
.thank-you { text-align: center; font-weight: bold; font-size: 10pt; margin: 20px 0; }
.footer-info { text-align: center; font-size: 8pt; color: #666; }
</style>
</head><body>

<div class='watermark'>${settings.companyName}</div>

<div class='receipt-container'>

<div class='header-section'>
${settings.logo ? `<div class='logo-section'><img src='${settings.logo}' alt='Company Logo'></div>` : ''}
<div class='company-info-section'>
<div class='company-name'>${settings.companyName.toUpperCase()}</div>
<div class='company-detail'>Phone: ${settings.phone}</div>
<div class='company-detail'>Email: ${settings.email}</div>
<div class='company-detail'>${settings.address}</div>
</div>
</div>
<div class='separator'></div>

<div class='title'>SALES RECEIPT</div>

<div class='info-box'>
<div class='info-row'>
<div class='info-column'>
<span class='info-label'>Receipt #:</span><span class='info-value'>${receipt.id}</span><br>
<span class='info-label'>Receipt Code:</span><span class='code-value'>${receipt.receiptCode}</span><br>
<span class='info-label'>Date:</span><span class='info-value'>${new Date(receipt.date).toLocaleDateString()}</span><br>
<span class='info-label'>Time:</span><span class='info-value'>${new Date(receipt.date).toLocaleTimeString()}</span>
</div>
<div class='info-column'>
<span class='info-label'>Customer:</span><span class='info-value'>${receipt.customerName}</span><br>
<span class='info-label'>Phone:</span><span class='info-value'>${receipt.customerPhone}</span><br>
${receipt.customerEmail ? `<span class='info-label'>Email:</span><span class='info-value'>${receipt.customerEmail}</span>` : ''}
</div>
</div>
</div>

<table>
<tr>
<th style='width: 35%;'>Description</th>
<th style='width: 20%;'>Category</th>
<th style='width: 10%;'>Qty</th>
<th style='width: 17%;'>Unit Price</th>
<th style='width: 18%;'>Total</th>
</tr>
${receipt.items.map(item => `
<tr>
<td>${item.description}</td>
<td>${item.category}</td>
<td>${item.quantity}</td>
<td>R ${formatCurrency(item.price)}</td>
<td>R ${formatCurrency(item.total)}</td>
</tr>
`).join('')}
</table>

<div class='total-box'>
<span class='total-label'>GRAND TOTAL:</span>
<span class='total-value'>R ${formatCurrency(receipt.total)}</span>
</div>

${receipt.notes ? `
<div class='notes-section'>
<div class='notes-title'>Notes:</div>
<div class='notes-content'>${receipt.notes}</div>
</div>
` : ''}

<div class='warranty'>${settings.warranty}</div>

<div class='disclaimer-section'>
<div class='disclaimer-title'>GENERAL SALES & REPAIRS DISCLAIMER</div>
<div class='disclaimer-text'>
All devices, accessories, and electronic equipment sold or repaired by us are handled in good faith. 
While every effort is made to ensure quality service and functional testing, we do not guarantee 
manufacturer warranty unless explicitly stated.<br><br>
We are not responsible for: Pre-existing faults, hidden defects, or data loss on devices; 
Damage caused by customer misuse, liquid exposure, power surges, or third-party repairs; 
Software issues, data corruption, or loss of personal information during repairs. 
Customers are advised to back up all data before handing in devices.<br><br>
All repairs are tested before release. Once the device leaves our premises, we are not liable for 
damage due to mishandling or unauthorized alterations. Used or second-hand devices are sold as-is, 
unless otherwise agreed in writing. No refunds or exchanges after completion of service or sale, 
except where required by law.<br><br>
By proceeding with a purchase or repair, the customer acknowledges and accepts these terms.
</div>
</div>

<div class='footer'>
<div class='signature-section'>
<div class='signature-line'>
<div class='signature-label'>Customer Signature:</div>
<div class='signature-underline'></div>
</div>
<div>
<div class='fingerprint-box'>Thumbprint</div>
</div>
</div>

<div class='thank-you'>Thank you for your business!</div>
<div class='footer-info'>All prices in South African Rand (R) | Receipt Code: ${receipt.receiptCode}</div>
</div>

</div>
</body></html>`;
    }

    function exportDatabase() {
      const data = {
        receipts: getFromStorage(STORAGE_KEYS.receipts),
        customers: getFromStorage(STORAGE_KEYS.customers),
        settings: settings,
        exportDate: new Date().toISOString(),
        version: '1.0'
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `CellphoneShop_Backup_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      alert('‚úÖ Database exported successfully!\n\nKeep this file safe - it contains all your data.');
    }

    function importDatabase(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          if (!confirm('‚ö†Ô∏è WARNING: This will replace ALL current data!\n\nAre you absolutely sure?')) {
            return;
          }

          if (data.receipts) saveToStorage(STORAGE_KEYS.receipts, data.receipts);
          if (data.customers) saveToStorage(STORAGE_KEYS.customers, data.customers);
          if (data.settings) {
            settings = data.settings;
            saveToStorage(STORAGE_KEYS.settings, data.settings);
          }
          
          alert('‚úÖ Database imported successfully!\n\nPage will reload to show new data.');
          location.reload();
        } catch (error) {
          alert('‚ùå Error importing database. Please check the file format.');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function handleLogoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 5000000) {
        alert('Logo file is too large! Please use an image under 5MB.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        settings.logo = e.target.result;
        updateLogoPreview();
        document.getElementById('logoStatus').textContent = file.name;
        alert('Logo uploaded! Click "Save All Settings" to keep it.');
      };
      reader.readAsDataURL(file);
    }

    function updateLogoPreview() {
      const preview = document.getElementById('logoPreview');
      const image = document.getElementById('logoImage');
      
      if (settings.logo) {
        image.src = settings.logo;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
    }

    function removeLogo() {
      if (confirm('Remove company logo?')) {
        settings.logo = '';
        updateLogoPreview();
        document.getElementById('logoStatus').textContent = 'No logo uploaded';
        document.getElementById('logoUpload').value = '';
        alert('Logo removed! Click "Save All Settings" to confirm.');
      }
    }

    function unlockSettings() {
      const password = document.getElementById('passwordInput').value;
      if (password === settings.password) {
        document.getElementById('settingsLocked').style.display = 'none';
        document.getElementById('settingsUnlocked').style.display = 'block';
        loadSettingsData();
      } else {
        alert('‚ùå Incorrect password!');
      }
    }

    function lockSettings() {
      document.getElementById('settingsLocked').style.display = 'block';
      document.getElementById('settingsUnlocked').style.display = 'none';
      document.getElementById('passwordInput').value = '';
    }

    function loadSettingsData() {
      document.getElementById('settingCompanyName').value = settings.companyName;
      document.getElementById('settingPhone').value = settings.phone;
      document.getElementById('settingEmail').value = settings.email;
      document.getElementById('settingAddress').value = settings.address;
      document.getElementById('settingWarranty').value = settings.warranty;
      
      if (settings.logo) {
        document.getElementById('logoStatus').textContent = 'Logo uploaded';
        updateLogoPreview();
      }
      
      const receipts = getFromStorage(STORAGE_KEYS.receipts);
      const customers = getFromStorage(STORAGE_KEYS.customers);
      document.getElementById('totalReceiptsCount').textContent = receipts.length;
      document.getElementById('totalCustomersCount').textContent = customers.length;
    }

    function saveSettings() {
      settings.companyName = document.getElementById('settingCompanyName').value;
      settings.phone = document.getElementById('settingPhone').value;
      settings.email = document.getElementById('settingEmail').value;
      settings.address = document.getElementById('settingAddress').value;
      settings.warranty = document.getElementById('settingWarranty').value;
      
      saveToStorage(STORAGE_KEYS.settings, settings);
      alert('‚úÖ Settings saved successfully!');
    }

    function changePassword() {
      const newPassword = prompt('Enter new password (minimum 6 characters):');
      if (!newPassword) return;
      
      if (newPassword.length < 6) {
        alert('‚ùå Password must be at least 6 characters!');
        return;
      }
      
      settings.password = newPassword;
      saveToStorage(STORAGE_KEYS.settings, settings);
      alert('‚úÖ Password changed successfully!');
      lockSettings();
    }

    window.addEventListener('DOMContentLoaded', function() {
      console.log('Cellphone Shop System initialized');
      alert('‚ú® Cellphone Shop Management System ‚ú®\n\nWelcome! System loaded successfully.\n\nDefault password: admin123');
    });
  </script>
</body>
</html>
